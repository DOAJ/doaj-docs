


<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for portality/scripts/sync_doaj_records.py: 0%</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">

<div id="header">
    <div class="content">
        <h1>Coverage for <b>portality/scripts/sync_doaj_records.py</b> :
            <span class="pc_cov">0%</span>
        </h1>

        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />

        <h2 class="stats">
            64 statements &nbsp;
            <span class="run hide_run shortkey_r button_toggle_run">0 run</span>
            <span class="mis shortkey_m button_toggle_mis">64 missing</span>
            <span class="exc shortkey_x button_toggle_exc">0 excluded</span>

            
        </h2>
    </div>
</div>

<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>

<div id="source">
    <table>
        <tr>
            <td class="linenos">
<p id="n1" class="pln"><a href="#n1">1</a></p>
<p id="n2" class="pln"><a href="#n2">2</a></p>
<p id="n3" class="pln"><a href="#n3">3</a></p>
<p id="n4" class="pln"><a href="#n4">4</a></p>
<p id="n5" class="pln"><a href="#n5">5</a></p>
<p id="n6" class="pln"><a href="#n6">6</a></p>
<p id="n7" class="pln"><a href="#n7">7</a></p>
<p id="n8" class="pln"><a href="#n8">8</a></p>
<p id="n9" class="pln"><a href="#n9">9</a></p>
<p id="n10" class="pln"><a href="#n10">10</a></p>
<p id="n11" class="pln"><a href="#n11">11</a></p>
<p id="n12" class="pln"><a href="#n12">12</a></p>
<p id="n13" class="pln"><a href="#n13">13</a></p>
<p id="n14" class="pln"><a href="#n14">14</a></p>
<p id="n15" class="stm mis"><a href="#n15">15</a></p>
<p id="n16" class="stm mis"><a href="#n16">16</a></p>
<p id="n17" class="stm mis"><a href="#n17">17</a></p>
<p id="n18" class="stm mis"><a href="#n18">18</a></p>
<p id="n19" class="stm mis"><a href="#n19">19</a></p>
<p id="n20" class="stm mis"><a href="#n20">20</a></p>
<p id="n21" class="pln"><a href="#n21">21</a></p>
<p id="n22" class="stm mis"><a href="#n22">22</a></p>
<p id="n23" class="pln"><a href="#n23">23</a></p>
<p id="n24" class="pln"><a href="#n24">24</a></p>
<p id="n25" class="stm mis"><a href="#n25">25</a></p>
<p id="n26" class="stm mis"><a href="#n26">26</a></p>
<p id="n27" class="pln"><a href="#n27">27</a></p>
<p id="n28" class="pln"><a href="#n28">28</a></p>
<p id="n29" class="stm mis"><a href="#n29">29</a></p>
<p id="n30" class="stm mis"><a href="#n30">30</a></p>
<p id="n31" class="stm mis"><a href="#n31">31</a></p>
<p id="n32" class="pln"><a href="#n32">32</a></p>
<p id="n33" class="stm mis"><a href="#n33">33</a></p>
<p id="n34" class="stm mis"><a href="#n34">34</a></p>
<p id="n35" class="pln"><a href="#n35">35</a></p>
<p id="n36" class="stm mis"><a href="#n36">36</a></p>
<p id="n37" class="stm mis"><a href="#n37">37</a></p>
<p id="n38" class="pln"><a href="#n38">38</a></p>
<p id="n39" class="stm mis"><a href="#n39">39</a></p>
<p id="n40" class="stm mis"><a href="#n40">40</a></p>
<p id="n41" class="stm mis"><a href="#n41">41</a></p>
<p id="n42" class="stm mis"><a href="#n42">42</a></p>
<p id="n43" class="stm mis"><a href="#n43">43</a></p>
<p id="n44" class="stm mis"><a href="#n44">44</a></p>
<p id="n45" class="pln"><a href="#n45">45</a></p>
<p id="n46" class="stm mis"><a href="#n46">46</a></p>
<p id="n47" class="stm mis"><a href="#n47">47</a></p>
<p id="n48" class="pln"><a href="#n48">48</a></p>
<p id="n49" class="stm mis"><a href="#n49">49</a></p>
<p id="n50" class="stm mis"><a href="#n50">50</a></p>
<p id="n51" class="pln"><a href="#n51">51</a></p>
<p id="n52" class="stm mis"><a href="#n52">52</a></p>
<p id="n53" class="stm mis"><a href="#n53">53</a></p>
<p id="n54" class="stm mis"><a href="#n54">54</a></p>
<p id="n55" class="stm mis"><a href="#n55">55</a></p>
<p id="n56" class="stm mis"><a href="#n56">56</a></p>
<p id="n57" class="stm mis"><a href="#n57">57</a></p>
<p id="n58" class="pln"><a href="#n58">58</a></p>
<p id="n59" class="stm mis"><a href="#n59">59</a></p>
<p id="n60" class="pln"><a href="#n60">60</a></p>
<p id="n61" class="pln"><a href="#n61">61</a></p>
<p id="n62" class="pln"><a href="#n62">62</a></p>
<p id="n63" class="stm mis"><a href="#n63">63</a></p>
<p id="n64" class="stm mis"><a href="#n64">64</a></p>
<p id="n65" class="stm mis"><a href="#n65">65</a></p>
<p id="n66" class="pln"><a href="#n66">66</a></p>
<p id="n67" class="stm mis"><a href="#n67">67</a></p>
<p id="n68" class="pln"><a href="#n68">68</a></p>
<p id="n69" class="pln"><a href="#n69">69</a></p>
<p id="n70" class="pln"><a href="#n70">70</a></p>
<p id="n71" class="stm mis"><a href="#n71">71</a></p>
<p id="n72" class="stm mis"><a href="#n72">72</a></p>
<p id="n73" class="stm mis"><a href="#n73">73</a></p>
<p id="n74" class="pln"><a href="#n74">74</a></p>
<p id="n75" class="pln"><a href="#n75">75</a></p>
<p id="n76" class="pln"><a href="#n76">76</a></p>
<p id="n77" class="pln"><a href="#n77">77</a></p>
<p id="n78" class="stm mis"><a href="#n78">78</a></p>
<p id="n79" class="stm mis"><a href="#n79">79</a></p>
<p id="n80" class="stm mis"><a href="#n80">80</a></p>
<p id="n81" class="pln"><a href="#n81">81</a></p>
<p id="n82" class="pln"><a href="#n82">82</a></p>
<p id="n83" class="stm mis"><a href="#n83">83</a></p>
<p id="n84" class="stm mis"><a href="#n84">84</a></p>
<p id="n85" class="pln"><a href="#n85">85</a></p>
<p id="n86" class="stm mis"><a href="#n86">86</a></p>
<p id="n87" class="stm mis"><a href="#n87">87</a></p>
<p id="n88" class="stm mis"><a href="#n88">88</a></p>
<p id="n89" class="stm mis"><a href="#n89">89</a></p>
<p id="n90" class="pln"><a href="#n90">90</a></p>
<p id="n91" class="stm mis"><a href="#n91">91</a></p>
<p id="n92" class="stm mis"><a href="#n92">92</a></p>
<p id="n93" class="stm mis"><a href="#n93">93</a></p>
<p id="n94" class="stm mis"><a href="#n94">94</a></p>
<p id="n95" class="stm mis"><a href="#n95">95</a></p>
<p id="n96" class="stm mis"><a href="#n96">96</a></p>
<p id="n97" class="stm mis"><a href="#n97">97</a></p>
<p id="n98" class="pln"><a href="#n98">98</a></p>
<p id="n99" class="stm mis"><a href="#n99">99</a></p>
<p id="n100" class="stm mis"><a href="#n100">100</a></p>
<p id="n101" class="stm mis"><a href="#n101">101</a></p>
<p id="n102" class="stm mis"><a href="#n102">102</a></p>
<p id="n103" class="pln"><a href="#n103">103</a></p>
<p id="n104" class="stm mis"><a href="#n104">104</a></p>
<p id="n105" class="stm mis"><a href="#n105">105</a></p>
<p id="n106" class="pln"><a href="#n106">106</a></p>
<p id="n107" class="pln"><a href="#n107">107</a></p>
<p id="n108" class="stm mis"><a href="#n108">108</a></p>
<p id="n109" class="stm mis"><a href="#n109">109</a></p>

            </td>
            <td class="text">
<p id="t1" class="pln"><span class="com">#!/usr/bin/python</span><span class="strut">&nbsp;</span></p>
<p id="t2" class="pln"><span class="com"># Syncs the last 1000 of DOAJ newest records which are not present in the locally</span><span class="strut">&nbsp;</span></p>
<p id="t3" class="pln"><span class="com"># Usage: ./sync_doaj_records.py source_server_ip destination_server_ip [test] [forever]</span><span class="strut">&nbsp;</span></p>
<p id="t4" class="pln"><span class="com"># E.g.: ./sync_doaj_records.py 95.85.59.151 95.85.48.213</span><span class="strut">&nbsp;</span></p>
<p id="t5" class="pln"><span class="com"># IF YOU run this script on doaj-staging, this will copy the newest 1000 records present in yonce to doaj-staging. It checks which ones to copy by querying the destination server's elasticsearch (assumed port 9200) and calculating which ones from the source are not present in there.</span><span class="strut">&nbsp;</span></p>
<p id="t6" class="pln"><span class="com"># Append "test" to the arguments to test the process first, see how many records would go into ES without actually putting them in</span><span class="strut">&nbsp;</span></p>
<p id="t7" class="pln"><span class="com"># Append "forever" to the arguments to keep syncing records forever. Useful during a server move..</span><span class="strut">&nbsp;</span></p>
<p id="t8" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t9" class="pln"><span class="com"># The script will sync all DOAJ objects in all types defined in portality.settings.MAPPINGS .</span><span class="strut">&nbsp;</span></p>
<p id="t10" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t11" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t12" class="pln"><span class="com"># Again, this script calculates which records needs to be synced from 2</span><span class="strut">&nbsp;</span></p>
<p id="t13" class="pln"><span class="com"># ES endpoints, but it will WRITE TO the elasticsearch instance defined</span><span class="strut">&nbsp;</span></p>
<p id="t14" class="pln"><span class="com"># in the application config!</span><span class="strut">&nbsp;</span></p>
<p id="t15" class="stm mis"><span class="key">import</span> <span class="nam">requests</span><span class="strut">&nbsp;</span></p>
<p id="t16" class="stm mis"><span class="key">import</span> <span class="nam">sys</span><span class="strut">&nbsp;</span></p>
<p id="t17" class="stm mis"><span class="key">import</span> <span class="nam">json</span><span class="strut">&nbsp;</span></p>
<p id="t18" class="stm mis"><span class="key">import</span> <span class="nam">time</span><span class="strut">&nbsp;</span></p>
<p id="t19" class="stm mis"><span class="key">from</span> <span class="nam">portality</span><span class="op">.</span><span class="nam">core</span> <span class="key">import</span> <span class="nam">app</span><span class="strut">&nbsp;</span></p>
<p id="t20" class="stm mis"><span class="nam">config</span> <span class="op">=</span> <span class="nam">app</span><span class="op">.</span><span class="nam">config</span><span class="strut">&nbsp;</span></p>
<p id="t21" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t22" class="stm mis"><span class="nam">ENDPOINT_TEMPLATE</span> <span class="op">=</span> <span class="str">"http://{server}:9200/doaj/{type}/_search?q=*&amp;size=1000&amp;sort=created_date:desc"</span><span class="strut">&nbsp;</span></p>
<p id="t23" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t24" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t25" class="stm mis"><span class="key">def</span> <span class="nam">abort</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t26" class="stm mis">    <span class="key">raise</span> <span class="nam">Exception</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t27" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t28" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t29" class="stm mis"><span class="key">def</span> <span class="nam">sync_type</span><span class="op">(</span><span class="nam">es_type</span><span class="op">,</span> <span class="nam">source_server</span><span class="op">,</span> <span class="nam">destination_server</span><span class="op">,</span> <span class="nam">testing</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t30" class="stm mis">    <span class="nam">src</span> <span class="op">=</span> <span class="nam">ENDPOINT_TEMPLATE</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">server</span><span class="op">=</span><span class="nam">source_server</span><span class="op">,</span> <span class="nam">type</span><span class="op">=</span><span class="nam">es_type</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t31" class="stm mis">    <span class="nam">dst</span> <span class="op">=</span> <span class="nam">ENDPOINT_TEMPLATE</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">server</span><span class="op">=</span><span class="nam">destination_server</span><span class="op">,</span> <span class="nam">type</span><span class="op">=</span><span class="nam">es_type</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t32" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t33" class="stm mis">    <span class="nam">source_data</span> <span class="op">=</span> <span class="nam">requests</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="nam">src</span><span class="op">)</span><span class="op">.</span><span class="nam">text</span><span class="strut">&nbsp;</span></p>
<p id="t34" class="stm mis">    <span class="nam">dest_data</span> <span class="op">=</span> <span class="nam">requests</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="nam">dst</span><span class="op">)</span><span class="op">.</span><span class="nam">text</span><span class="strut">&nbsp;</span></p>
<p id="t35" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t36" class="stm mis">    <span class="nam">s</span> <span class="op">=</span> <span class="nam">json</span><span class="op">.</span><span class="nam">loads</span><span class="op">(</span><span class="nam">source_data</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t37" class="stm mis">    <span class="nam">d</span> <span class="op">=</span> <span class="nam">json</span><span class="op">.</span><span class="nam">loads</span><span class="op">(</span><span class="nam">dest_data</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t38" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t39" class="stm mis">    <span class="key">try</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t40" class="stm mis">        <span class="nam">s_total</span> <span class="op">=</span> <span class="nam">s</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="op">[</span><span class="str">'total'</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t41" class="stm mis">        <span class="nam">s</span> <span class="op">=</span> <span class="nam">s</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t42" class="stm mis">    <span class="key">except</span> <span class="nam">KeyError</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t43" class="stm mis">        <span class="nam">print</span><span class="op">(</span><span class="str">'Skipping'</span><span class="op">,</span> <span class="nam">es_type</span><span class="op">,</span> <span class="str">'does not have created_date in its mapping. Probably 0 documents, so no mapping beyond the dynamic template has been created, so no point in syncing this type anyway.'</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t44" class="stm mis">        <span class="key">return</span><span class="strut">&nbsp;</span></p>
<p id="t45" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t46" class="stm mis">    <span class="nam">d_total</span> <span class="op">=</span> <span class="nam">d</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="op">[</span><span class="str">'total'</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t47" class="stm mis">    <span class="nam">d</span> <span class="op">=</span> <span class="nam">d</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="op">[</span><span class="str">'hits'</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t48" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t49" class="stm mis">    <span class="key">if</span> <span class="nam">s_total</span> <span class="op">&lt;</span> <span class="nam">d_total</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t50" class="stm mis">        <span class="nam">abort</span><span class="op">(</span><span class="str">"Source has less docs than destination, aborting since your source and destination could be completely out of sync (both have docs than the other one does not). Investigate, fix and rerun."</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t51" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t52" class="stm mis">    <span class="nam">removed</span> <span class="op">=</span> <span class="num">0</span><span class="strut">&nbsp;</span></p>
<p id="t53" class="stm mis">    <span class="key">for</span> <span class="nam">s_hit</span> <span class="key">in</span> <span class="nam">s</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t54" class="stm mis">        <span class="key">for</span> <span class="nam">d_hit</span> <span class="key">in</span> <span class="nam">d</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t55" class="stm mis">            <span class="key">if</span> <span class="nam">s_hit</span><span class="op">[</span><span class="str">"_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">d_hit</span><span class="op">[</span><span class="str">"_id"</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t56" class="stm mis">                <span class="nam">removed</span> <span class="op">+=</span> <span class="num">1</span><span class="strut">&nbsp;</span></p>
<p id="t57" class="stm mis">                <span class="nam">s</span><span class="op">.</span><span class="nam">remove</span><span class="op">(</span><span class="nam">s_hit</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t58" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t59" class="stm mis">    <span class="nam">print</span><span class="op">(</span><span class="str">'Putting'</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">s</span><span class="op">)</span><span class="op">,</span> <span class="str">'newest records into ES.'</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t60" class="pln">    <span class="com"># print 'You have 5 seconds to terminate this script with Ctrl+C if the number seems off.'</span><span class="strut">&nbsp;</span></p>
<p id="t61" class="pln">    <span class="com"># time.sleep(5)</span><span class="strut">&nbsp;</span></p>
<p id="t62" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t63" class="stm mis">    <span class="key">for</span> <span class="nam">diff</span> <span class="key">in</span> <span class="nam">s</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t64" class="stm mis">        <span class="key">if</span> <span class="nam">testing</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t65" class="stm mis">            <span class="nam">print</span><span class="op">(</span><span class="str">'TESTING - would PUT'</span><span class="op">,</span> <span class="nam">diff</span><span class="op">[</span><span class="str">'_id'</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t66" class="pln">        <span class="key">else</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t67" class="stm mis">            <span class="nam">r</span> <span class="op">=</span> <span class="nam">requests</span><span class="op">.</span><span class="nam">put</span><span class="op">(</span><span class="strut">&nbsp;</span></p>
<p id="t68" class="pln">                <span class="str">'{es_host}/{es_index}/{es_type}/{rec_id}'</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">es_host</span><span class="op">=</span><span class="nam">config</span><span class="op">[</span><span class="str">'ELASTIC_SEARCH_HOST'</span><span class="op">]</span><span class="op">,</span> <span class="nam">es_index</span><span class="op">=</span><span class="nam">config</span><span class="op">[</span><span class="str">'ELASTIC_SEARCH_DB'</span><span class="op">]</span><span class="op">,</span> <span class="nam">es_type</span><span class="op">=</span><span class="nam">es_type</span><span class="op">,</span> <span class="nam">rec_id</span><span class="op">=</span><span class="nam">diff</span><span class="op">[</span><span class="str">'_id'</span><span class="op">]</span><span class="op">)</span><span class="op">,</span><span class="strut">&nbsp;</span></p>
<p id="t69" class="pln">                <span class="nam">data</span><span class="op">=</span><span class="nam">json</span><span class="op">.</span><span class="nam">dumps</span><span class="op">(</span><span class="nam">diff</span><span class="op">[</span><span class="str">'_source'</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t70" class="pln">            <span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t71" class="stm mis">            <span class="nam">print</span><span class="op">(</span><span class="nam">diff</span><span class="op">[</span><span class="str">'_id'</span><span class="op">]</span><span class="op">,</span> <span class="nam">r</span><span class="op">.</span><span class="nam">status_code</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t72" class="stm mis">            <span class="key">if</span> <span class="nam">r</span><span class="op">.</span><span class="nam">status_code</span> <span class="key">not</span> <span class="key">in</span> <span class="op">[</span><span class="num">200</span><span class="op">,</span> <span class="num">201</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t73" class="stm mis">                <span class="nam">print</span><span class="op">(</span><span class="str">'ES error for record'</span><span class="op">,</span> <span class="nam">diff</span><span class="op">[</span><span class="str">'_id'</span><span class="op">]</span><span class="op">,</span> <span class="str">'HTTP status code:'</span><span class="op">,</span> <span class="nam">r</span><span class="op">.</span><span class="nam">status_code</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t74" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t75" class="pln">    <span class="com">#print 'PUT', len(s), 'newest records into ES.'</span><span class="strut">&nbsp;</span></p>
<p id="t76" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t77" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t78" class="stm mis"><span class="key">def</span> <span class="nam">main</span><span class="op">(</span><span class="nam">argv</span><span class="op">=</span><span class="key">None</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t79" class="stm mis">    <span class="key">if</span> <span class="key">not</span> <span class="nam">argv</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t80" class="stm mis">        <span class="nam">argv</span> <span class="op">=</span> <span class="nam">sys</span><span class="op">.</span><span class="nam">argv</span><span class="strut">&nbsp;</span></p>
<p id="t81" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t82" class="pln">    <span class="com"># TODO use argparse and remove this terrible mess</span><span class="strut">&nbsp;</span></p>
<p id="t83" class="stm mis">    <span class="nam">source_server</span> <span class="op">=</span> <span class="nam">argv</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t84" class="stm mis">    <span class="nam">destination_server</span> <span class="op">=</span> <span class="nam">argv</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t85" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t86" class="stm mis">    <span class="nam">testing</span> <span class="op">=</span> <span class="key">False</span><span class="strut">&nbsp;</span></p>
<p id="t87" class="stm mis">    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">argv</span><span class="op">)</span> <span class="op">></span> <span class="num">3</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t88" class="stm mis">        <span class="key">if</span> <span class="nam">argv</span><span class="op">[</span><span class="num">3</span><span class="op">]</span> <span class="op">==</span> <span class="str">'test'</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t89" class="stm mis">            <span class="nam">testing</span> <span class="op">=</span> <span class="key">True</span><span class="strut">&nbsp;</span></p>
<p id="t90" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t91" class="stm mis">    <span class="nam">forever</span> <span class="op">=</span> <span class="key">False</span><span class="strut">&nbsp;</span></p>
<p id="t92" class="stm mis">    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">argv</span><span class="op">)</span> <span class="op">></span> <span class="num">3</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t93" class="stm mis">        <span class="key">if</span> <span class="nam">argv</span><span class="op">[</span><span class="num">3</span><span class="op">]</span> <span class="op">==</span> <span class="str">'forever'</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t94" class="stm mis">            <span class="nam">forever</span> <span class="op">=</span> <span class="key">True</span><span class="strut">&nbsp;</span></p>
<p id="t95" class="stm mis">    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">argv</span><span class="op">)</span> <span class="op">></span> <span class="num">4</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t96" class="stm mis">        <span class="key">if</span> <span class="nam">argv</span><span class="op">[</span><span class="num">4</span><span class="op">]</span> <span class="op">==</span> <span class="str">'forever'</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t97" class="stm mis">            <span class="nam">forever</span> <span class="op">=</span> <span class="key">True</span><span class="strut">&nbsp;</span></p>
<p id="t98" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t99" class="stm mis">    <span class="key">if</span> <span class="nam">forever</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t100" class="stm mis">        <span class="key">while</span> <span class="key">True</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t101" class="stm mis">            <span class="key">for</span> <span class="nam">es_type</span> <span class="key">in</span> <span class="nam">config</span><span class="op">[</span><span class="str">'MAPPINGS'</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t102" class="stm mis">                <span class="nam">sync_type</span><span class="op">(</span><span class="nam">es_type</span><span class="op">,</span> <span class="nam">source_server</span><span class="op">,</span> <span class="nam">destination_server</span><span class="op">,</span> <span class="nam">testing</span><span class="op">=</span><span class="nam">testing</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t103" class="pln">    <span class="key">else</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t104" class="stm mis">        <span class="key">for</span> <span class="nam">es_type</span> <span class="key">in</span> <span class="nam">config</span><span class="op">[</span><span class="str">'MAPPINGS'</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t105" class="stm mis">            <span class="nam">sync_type</span><span class="op">(</span><span class="nam">es_type</span><span class="op">,</span> <span class="nam">source_server</span><span class="op">,</span> <span class="nam">destination_server</span><span class="op">,</span> <span class="nam">testing</span><span class="op">=</span><span class="nam">testing</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t106" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t107" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t108" class="stm mis"><span class="key">if</span> <span class="nam">__name__</span> <span class="op">==</span> <span class="str">'__main__'</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t109" class="stm mis">    <span class="nam">main</span><span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>

            </td>
        </tr>
    </table>
</div>

<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v4.5.4</a>,
            created at 2019-10-11 10:52
        </p>
    </div>
</div>

</body>
</html>
